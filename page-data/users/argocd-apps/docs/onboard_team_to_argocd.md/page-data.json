{"componentChunkName":"component---src-templates-markdown-js","path":"/users/argocd-apps/docs/onboard_team_to_argocd.md","result":{"data":{"site":{"siteMetadata":{"title":"Operate First"}},"markdownRemark":{"id":"bbae55a8-6e3c-51d0-9cac-45614a00be11","html":"<h1 id=\"argocd-onboarding-procedure\" style=\"position:relative;\"><a href=\"#argocd-onboarding-procedure\" aria-label=\"argocd onboarding procedure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ArgoCD onboarding procedure</h1>\n<p>Onboarding a team requires the following steps to be taken.</p>\n<h2 id=\"create-openshift-group\" style=\"position:relative;\"><a href=\"#create-openshift-group\" aria-label=\"create openshift group permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create openshift-group</h2>\n<p>To add multi-tenancy support, we require the team to have an openshift group on the MOC cluster on which our ArgoCD instance resides.\nThis openshift group should include all the people belonging to the team that will need write-level access to applications\nbelonging to the team’s ArgoCD Project (explained later). An openshift group needs to be requested by making an issue\n<a href=\"https://gitlab.com/open-infrastructure-labs/moc-cnv-sandbox/-/issues\">here</a>.</p>\n<h2 id=\"create-project-directories-for-this-repository\" style=\"position:relative;\"><a href=\"#create-project-directories-for-this-repository\" aria-label=\"create project directories for this repository permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Create project directories for this repository</h2>\n<p>To create the project directories, use the the following script provided:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./create-project.sh project_name</code></pre></div>\n<p>This will create the necessary folders/files that respects the project structure of this repository.</p>\n<p>Teams should be directed <a href=\"add_application.md\">here</a> for instructions on how to structure their ArgoCD Applications.\nAll Applications should go in the team’s <a href=\"https://argoproj.github.io/argo-cd/user-guide/projects/\">ArgoCD Project</a>,\nsee below for instructions on adding an ArgoCD Project.</p>\n<h2 id=\"argocd-project\" style=\"position:relative;\"><a href=\"#argocd-project\" aria-label=\"argocd project permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ArgoCD Project</h2>\n<p>The team will need a dedicated <a href=\"https://argoproj.github.io/argo-cd/user-guide/projects/\">ArgoCD Project</a> for their\n<a href=\"https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/#applications\">ArgoCD Applications</a>. The\nArgoCD project should be added <a href=\"https://gitlab.com/open-infrastructure-labs/moc-cnv-sandbox/-/tree/master/manifests/argocd/overlays/prod/projects\">here</a>.</p>\n<p>A typical project will look like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AppProject\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'&lt;team-namespace-prefix>-*'</span>\n      <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://kubernetes.default.svc'</span>\n  <span class=\"token key atrule\">sourceRepos</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">'*'</span>\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> project<span class=\"token punctuation\">-</span>admin\n      <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> Read/Write access to this project only\n      <span class=\"token key atrule\">policies</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> get<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> delete<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> sync<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> override<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n        <span class=\"token punctuation\">-</span> p<span class=\"token punctuation\">,</span> proj<span class=\"token punctuation\">:</span>&lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>project<span class=\"token punctuation\">-</span>admin<span class=\"token punctuation\">,</span> applications<span class=\"token punctuation\">,</span> action/*<span class=\"token punctuation\">,</span> &lt;team<span class=\"token punctuation\">-</span>name<span class=\"token punctuation\">></span>/*<span class=\"token punctuation\">,</span> allow\n      <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> &lt;team<span class=\"token punctuation\">-</span>openshift<span class=\"token punctuation\">-</span>group<span class=\"token punctuation\">></span>\n        <span class=\"token punctuation\">-</span> operate<span class=\"token punctuation\">-</span>first\n  <span class=\"token key atrule\">clusterResourceWhitelist</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> <span class=\"token string\">''</span>\n      <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Namespace\n  <span class=\"token key atrule\">namespaceResourceWhitelist</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">...</span>.</code></pre></div>\n<p>Some notes:</p>\n<ul class=\"pf-c-list\">\n<li>Ensure that the <code class=\"language-text\">spec.destinations</code> field contains a prefix for the team’s namespaces. The team will be required to\nprefix their namespaces with this attribute if they want ArgoCD to be able to deploy to them, any other namespaces not\nfollowing the prefix will need to be added manually under this field. See additional notes for more details.</li>\n<li>Ensure <code class=\"language-text\">operate-first</code> is added into the <code class=\"language-text\">roles.groups</code> for each role. This allows the operate-first team to\nhelp diagnose issues.</li>\n<li><code class=\"language-text\">namespaceResourceWhitelist</code> generally contains the list of resources a project <code class=\"language-text\">admin</code> has access to. The general idea\nis that a team should be able to deploy via ArgoCD what they can deploy using <code class=\"language-text\">oc apply</code>. See other projects for a list of\nsuch resources.</li>\n<li>Ensure that the argocd project is included in the <code class=\"language-text\">kustomization.yaml</code> <a href=\"https://gitlab.com/open-infrastructure-labs/moc-cnv-sandbox/-/blob/master/manifests/argocd/overlays/prod/projects/kustomization.yaml\">here</a>.</li>\n</ul>\n<h2 id=\"enable-openshift-auth-to-argocd-console\" style=\"position:relative;\"><a href=\"#enable-openshift-auth-to-argocd-console\" aria-label=\"enable openshift auth to argocd console permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Enable openshift auth to ArgoCD Console</h2>\n<p>By default all users should be able to see the <a href=\"https://argocd-server-aicoe-argocd.apps.ocp4.prod.psi.redhat.com\">ArgoCD console</a>.\nTo be able to make changes to applications belonging to the team’s ArgoCD Project (via the cli or ui), the team will need\nto be able to log into the console with appropriate access. This accomplished by adding the team’s openshift group\nmentioned in the beginning under the dex config <a href=\"https://gitlab.com/open-infrastructure-labs/moc-cnv-sandbox/-/blob/master/manifests/argocd/overlays/prod/configs/argo_cm/dex.config#L11\">here</a>.</p>\n<h3 id=\"additional-notes\" style=\"position:relative;\"><a href=\"#additional-notes\" aria-label=\"additional notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Additional Notes:</h3>\n<h3 id=\"namespace-prefix\" style=\"position:relative;\"><a href=\"#namespace-prefix\" aria-label=\"namespace prefix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Namespace Prefix</h3>\n<p>An ArgoCD project allows us to ensure that a team cannot deploy applications onto another team’s namespace via ArgoCD.</p>\n<p>We accomplish this by allowing teams to add the namespaces that they will be deploying to in their ArgoCD Project CR under\nthe <code class=\"language-text\">spec.destinations.</code> field. Example:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> AppProject\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> example<span class=\"token punctuation\">-</span>project\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> argocd\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> guestbook\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://kubernetes.default.svc'</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n<p>The project above can only deploy into the <code class=\"language-text\">guestbook</code> namespace in the host cluster.</p>\n<p>It can get bit tedious having to always require a team to submit a pr updating the <code class=\"language-text\">spec.destinations</code> to include new\nnamespaces their project applications can deploy onto, so we can use wildcards to include a set of namespaces that\nbegin with a prefix. For example, the <code class=\"language-text\">thoth</code> team has the following prefix in their <code class=\"language-text\">spec.destinations</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">destinations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'thoth-*'</span>\n      <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'https://kubernetes.default.svc'</span></code></pre></div>\n<p>Now, as long as all thoth team’s namespaces have <code class=\"language-text\">metadata.name</code> beginning with a <code class=\"language-text\">thoth-</code> prefix, they can deploy\ninto these namespaces using ArgoCD Applications that are part of the <code class=\"language-text\">thoth</code> project.</p>\n<h3 id=\"resources\" style=\"position:relative;\"><a href=\"#resources\" aria-label=\"resources permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resources:</h3>\n<ul class=\"pf-c-list\">\n<li>To read more about ArgoCD Declarative setup <a href=\"https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/\">see here</a></li>\n<li>To understand our authentication setup <a href=\"https://argoproj.github.io/argo-cd/operator-manual/user-management/#dex\">see here</a></li>\n<li>To read about ArgoCD Projects <a href=\"https://argoproj.github.io/argo-cd/user-guide/projects/\">see here</a></li>\n<li>To learn about Kustomize bases &#x26; overlays <a href=\"https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/#bases-and-overlays\">see here</a></li>\n</ul>","fields":{"srcLink":"https://github.com/operate-first/argocd-apps/blob/master/docs/onboard_team_to_argocd.md"},"frontmatter":{"title":"","description":null}}},"pageContext":{"id":"bbae55a8-6e3c-51d0-9cac-45614a00be11"}},"staticQueryHashes":["117426894","3000541721"]}